<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JIWU吉物販售．寶寶目錄</title>
  <link rel="icon" href="https://i.postimg.cc/3R7nNT0k/icon.png" type="image/png" />
  <style>
    :root { --theme-color: #d77485; }
    body {
      font-family: "Noto Sans TC", Arial, sans-serif;
      margin: 0;
      background: #f9f9f9;
      color: #333;
    }
    .top-bar {
      background: var(--theme-color);
      color: #fff;
      text-align: center;
      padding: 12px 10px;
      font-weight: 700;
      user-select: none;
      animation: bounce 1.2s ease-in-out infinite alternate;
      position: sticky;
      top: 0;
      z-index: 9999;
    }
    .top-bar a {
      color: #fff;
      text-decoration: none;
    }
    @keyframes bounce {
      0% { transform: scale(1); }
      100% { transform: scale(1.1); }
    }
    h1 {
      text-align: center;
      margin: 20px 0 10px;
      font-weight: 700;
    }
    .section-title {
      background: var(--theme-color);
      color: #fff;
      font-weight: 700;
      padding: 6px 12px;
      margin: 20px 10px 8px;
      border-radius: 6px;
      user-select: none;
      font-size: 1.1em;
    }
    .type-divider {
      display: flex;
      align-items: center;
      margin: 14px 0 8px;
      color: #666;
      user-select: none;
      font-weight: 600;
      font-size: 0.95em;
    }
    .type-divider::before,
    .type-divider::after {
      content: "";
      flex: 1;
      border-top: 1px solid #ccc;
      margin: 0 10px;
    }
    .card-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      padding: 0 10px 20px;
      justify-items: center;
    }
    .card {
      border: 2px solid var(--theme-color);
      border-radius: 8px;
      background: #fff;
      width: 150px;
      box-sizing: border-box;
      text-align: center;
      padding: 8px 6px;
      user-select: none;
      cursor: default;
      transition: box-shadow 0.3s ease;
    }
    .card:hover {
      box-shadow: 0 4px 10px rgba(215, 116, 133, 0.6);
    }
    .card img {
      width: 100%;
      height: 120px;
      object-fit: contain;
      border-radius: 6px;
      user-select: none;
    }
    .card .name {
      font-weight: 700;
      margin: 8px 0 4px;
      font-size: 1em;
      color: #333;
    }
    .card .price {
      color: var(--theme-color);
      font-weight: 600;
      font-size: 0.9em;
      margin-bottom: 4px;
    }
    .card .stock {
      font-size: 0.85em;
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <a href="https://lin.ee/X6FUFI9" target="_blank" rel="noopener noreferrer">訂購這邊找花花 (৹˙꒳˙ฅ)</a>
  </div>
  
  <main id="content">資料載入中...</main>

  <script>
const SHEET_ID = "1iCEqgnGGa_TVVbx90xNWxDzw94VfqF8IsXRvpKMY";
const SHEET_NAME = "ちいかわ";
const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;

// -----------
// 分頁專用篩選設定
// -----------
// mode: "role" = 用角色欄篩選
// mode: "name" = 用名稱欄篩選
// mode: "type" = 用種類欄篩選
// 範例：吉伊分頁，只要角色欄有「吉」
// const filterConfig = { mode: "role", key: "吉" };
// 仙境分頁，名稱欄含「仙境」
// const filterConfig = { mode: "name", key: "仙境" };
// 貼紙膠帶分頁，種類欄含「貼紙」
// const filterConfig = { mode: "type", keys: ["貼紙"] };

const filterConfig = {
  mode: "role",
  key: "吉",
};

// 角色字對應（用來分組排序）
const roleMap = {
  "吉伊": "吉",
  "小八": "八",
  "兔兔": "兔",
  "小桃": "桃",
  "師傅": "獺",
  "栗子": "栗",
  "獅薩": "獅",
  "古本": "古",
  "其他角色": "其",
};

// 種類群組排序（依照你需求排序）
const typeGroupsOrder = [
  { name: "吊娃、娃", keys: ["吊娃", "娃"] },
  { name: "包包", keys: ["包包"] },
  { name: "鑰匙圈、御守", keys: ["鑰匙圈", "御守"] },
  { name: "立牌、徽章、磁鐵、玩具", keys: ["立牌", "徽章", "磁鐵", "玩具"] },
  { name: "文具、貼紙", keys: ["文具", "貼紙"] },
  { name: "3C、居家、毛巾", keys: ["3C", "居家", "毛巾"] },
  { name: "飾品、衣服", keys: ["飾品", "衣服"] },
  { name: "餐廚", keys: ["餐廚"] },
];

// 取得種類所屬群組名稱
function getTypeGroupName(type) {
  for (const group of typeGroupsOrder) {
    if (group.keys.some(k => type.includes(k))) return group.name;
  }
  return "其他";
}

fetch(url)
  .then(res => res.text())
  .then(t => JSON.parse(t.substr(47).slice(0, -2)))
  .then(data => {
    const rows = data.table.rows.slice(1);

    // 轉成物件方便取欄位
    const items = rows.map(row => {
      const c = row.c;
      return {
        type: c[1]?.v || "",       // 種類欄（注意試算表順序，角色欄是c[0]，種類欄是c[1]）
        name: c[2]?.v || "",       // 名稱欄
        role: c[0]?.v || "",       // 角色欄
        price: c[4]?.v || "",      // 售價
        stock: c[5]?.v || "",      // 庫存
        nonStock: c[6]?.v || "",   // 非現
        onShelf: c[7]?.v || "",    // 上架
        acceptOrder: c[8]?.v || "",// 受注
        img: c[10]?.v || "",       // 商品圖片
      };
    });

    // 篩選符合分頁條件的資料
    let filteredItems = [];
    if (filterConfig.mode === "role") {
      filteredItems = items.filter(item => item.role.includes(filterConfig.key));
    } else if (filterConfig.mode === "name") {
      filteredItems = items.filter(item => item.name.includes(filterConfig.key));
    } else if (filterConfig.mode === "type") {
      filteredItems = items.filter(item =>
        filterConfig.keys.some(k => item.type.includes(k))
      );
    }

    // 不顯示上架欄有 x 的商品
    filteredItems = filteredItems.filter(item => !(item.onShelf && item.onShelf.toLowerCase() === "x"));

    // ---------
    // 分組：先以角色排序 (若mode是role才用)
    // 若mode不是role，可自行決定要不要分組
    // ---------
    let grouped = {};

    if (filterConfig.mode === "role") {
      // 建立角色分組，保持order，其他角色放最後
      for (const roleName of Object.keys(roleMap)) {
        grouped[roleName] = [];
      }

      // 分配資料進對應角色分組，角色欄含「其」為其他角色
      filteredItems.forEach(item => {
        if (item.role.includes("其")) {
          grouped["其他角色"].push(item);
          return;
        }
        for (const [rName, rKey] of Object.entries(roleMap)) {
          if (rName === "其他角色") continue;
          if (item.role.includes(rKey)) {
            grouped[rName].push(item);
            return;
          }
        }
      });

      // 移除空分組
      Object.keys(grouped).forEach(k => {
        if (grouped[k].length === 0) delete grouped[k];
      });
    } else {
      // 不是角色模式，全部當一組
      grouped["全部商品"] = filteredItems;
    }

    const content = document.getElementById("content");
    content.innerHTML = "";

    // 依序建立組別區塊
    for (const [groupName, groupItems] of Object.entries(grouped)) {
      if (groupItems.length === 0) continue;

      // 角色分組標題（若mode是role）
      if (filterConfig.mode === "role") {
        const sectionTitle = document.createElement("div");
        sectionTitle.className = "section-title";
        sectionTitle.textContent = groupName;
        content.appendChild(sectionTitle);
      }

      // 按種類分組並排序
      const typeGroups = {};
      for (const g of typeGroupsOrder) typeGroups[g.name] = [];
      typeGroups["其他"] = [];

      groupItems.forEach(item => {
        const tgName = getTypeGroupName(item.type);
        if (typeGroups[tgName]) {
          typeGroups[tgName].push(item);
        } else {
          typeGroups["其他"].push(item);
        }
      });

      // 依照typeGroupsOrder排序，顯示種類區隔標題和商品卡
      for (const tg of typeGroupsOrder) {
        const tgName = tg.name;
        const tgItems = typeGroups[tgName];
        if (!tgItems || tgItems.length === 0) continue;

        // 種類分隔標題
        const typeDivider = document.createElement("div");
        typeDivider.className = "type-divider";
        typeDivider.textContent = tgName;
        content.appendChild(typeDivider);

        // 商品卡容器
        const cardContainer = document.createElement("div");
        cardContainer.className = "card-container";

        tgItems.forEach(item => {
          // 貨況判斷
          let stockHtml = "";
          if (item.acceptOrder && item.acceptOrder.toLowerCase() === "v") {
            stockHtml = `<span style="background:#74BDCB;color:#ffffff;padding:2px 8px;border-radius:12px;display:inline-block;">受注品</span>`;
          } else if (item.stock && parseInt(item.stock) > 0) {
            stockHtml = `<span style="background:#FFF4BD;color:#333333;padding:2px 8px;border-radius:12px;display:inline-block;">現貨</span>`;
          } else if ((!item.stock || parseInt(item.stock) === 0) && (!item.nonStock || item.nonStock.trim() === "")) {
            stockHtml = `<span style="background:#D4BBDD;color:#333333;padding:2px 8px;border-radius:12px;display:inline-block;">需預訂</span>`;
          } else if ((!item.stock || parseInt(item.stock) === 0) && item.nonStock && item.nonStock.trim() !== "") {
            stockHtml = `<span style="background:#5885AF;color:#ffffff;padding:2px 8px;border-radius:12px;display:inline-block;">搭飛機中</span>`;
          } else if (!item.stock || item.stock.trim() === "") {
            stockHtml = `<span style="background:#E7F2F8;color:#333333;padding:2px 8px;border-radius:12px;display:inline-block;">點貨中</span>`;
          }

          // 商品卡HTML
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <div class="stock">${stockHtml}</div>
            <div class="name">${item.name}</div>
            <img src="${item.img || 'https://i.postimg.cc/bv5xRs04/image.png'}" alt="${item.name}">
            <div class="price">${item.price}</div>
          `;
          cardContainer.appendChild(card);
        });

        content.appendChild(cardContainer);
      }
    }
  })
  .catch(e => {
    document.getElementById("content").innerHTML = "資料載入失敗，請稍後再試。";
    console.error(e);
  });
</script>
</body>
</html>
