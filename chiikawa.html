<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JIWU吉物販售．寶寶目錄</title>
  <link rel="icon" href="https://i.postimg.cc/3R7nNT0k/icon.png" type="image/png" />
  <style>
    :root { --theme-color: #d77485; }
    body {
      font-family: "Noto Sans TC", Arial, sans-serif;
      margin: 0;
      background: #f9f9f9;
      color: #333;
    }
    .top-bar {
      background: var(--theme-color);
      color: #fff;
      text-align: center;
      padding: 12px 10px;
      font-weight: 700;
      user-select: none;
      animation: bounce 1.2s ease-in-out infinite alternate;
      position: sticky;
      top: 0;
      z-index: 9999;
    }
    .top-bar a {
      color: #fff;
      text-decoration: none;
    }
    @keyframes bounce {
      0% { transform: scale(1); }
      100% { transform: scale(1.1); }
    }
    h1 {
      text-align: center;
      margin: 20px 0 10px;
      font-weight: 700;
    }
    .section-title {
      background: var(--theme-color);
      color: #fff;
      font-weight: 700;
      padding: 6px 12px;
      margin: 20px 10px 8px;
      border-radius: 6px;
      user-select: none;
      font-size: 1.1em;
    }
    .type-divider {
      display: flex;
      align-items: center;
      margin: 14px 0 8px;
      color: #666;
      user-select: none;
      font-weight: 600;
      font-size: 0.95em;
    }
    .type-divider::before,
    .type-divider::after {
      content: "";
      flex: 1;
      border-top: 1px solid #ccc;
      margin: 0 10px;
    }
    .card-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      padding: 0 10px 20px;
      justify-items: center;
    }
    .card {
      border: 2px solid var(--theme-color);
      border-radius: 8px;
      background: #fff;
      width: 150px;
      box-sizing: border-box;
      text-align: center;
      padding: 8px 6px;
      user-select: none;
      cursor: default;
      transition: box-shadow 0.3s ease;
    }
    .card:hover {
      box-shadow: 0 4px 10px rgba(215, 116, 133, 0.6);
    }
    .card img {
      width: 100%;
      height: 120px;
      object-fit: contain;
      border-radius: 6px;
      user-select: none;
    }
    .card .name {
      font-weight: 700;
      margin: 8px 0 4px;
      font-size: 1em;
      color: #333;
    }
    .card .price {
      color: var(--theme-color);
      font-weight: 600;
      font-size: 0.9em;
      margin-bottom: 4px;
    }
    .card .stock {
      font-size: 0.85em;
      color: #555;
      margin-bottom: 4px;
    }
    @media (min-width: 768px) {
      .card {
        width: 180px;
      }
      .card img {
        height: 140px;
      }
      .section-title {
        font-size: 1.3em;
      }
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <a href="https://lin.ee/X6FUFI9" target="_blank" rel="noopener noreferrer">訂購這邊找花花 (৹˙꒳˙ฅ)</a>
  </div>
  <h1>JIWU吉物販售．ちいかわ</h1>

  <main id="content">資料載入中...</main>

  <script>
    // 讀取 URL 中 ?role=xxx
    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    const selectedRole = getQueryParam('role');

    const SHEET_ID = "1iCEqgnGGa_TVVbx90xNWxDzwKtz94VfqF8IsXRvpKMY";
    const SHEET_NAME = "ちいかわ";
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;

    const roleMap = {
      "吉伊": "吉",
      "小八": "八",
      "兔兔": "兔",
      "小桃": "桃",
      "師傅": "獺",
      "栗子": "栗",
      "獅薩": "獅",
      "古本": "古",
      "其他角色": "其"
    };

    const typeMap = {
      "貼紙膠帶": ["貼紙"],
      "文具磁鐵": ["文具", "磁鐵"],
      "立牌徽章": ["立牌", "徽章"],
      "鑰匙圈御守": ["鑰匙圈", "御守"],
      "玩具盲抽": ["玩具", "盲"],
      "服飾包袋": ["包包", "衣服", "飾品"],
      "生活居家": ["3C", "居家", "毛巾"],
      "餐廚用品": ["餐廚"]
    };

    // 貨況判斷，依優先順序顯示（上架、受注、非現、庫存）
    function stockStatus(item) {
      if (item["上架"] && item["上架"].toLowerCase() === "否") return "未上架";
      if (item["受注"] && item["受注"].toLowerCase() === "是") return "受注中";
      if (item["非現"] && item["非現"].toLowerCase() === "是") return "非現貨";
      if (item["庫存"]) {
        if (parseInt(item["庫存"]) > 0) return `庫存：${item["庫存"]}`;
        return "已售完";
      }
      return "無資料";
    }

    fetch(url)
      .then(res => res.text())
      .then(t => JSON.parse(t.substr(47).slice(0, -2)))
      .then(data => {
        const rows = data.table.rows.slice(1);

        // 轉成物件方便取欄位
        const items = rows.map(row => {
          const c = row.c;
          return {
            type: c[0]?.v || "",
            name: c[1]?.v || "",
            role: c[2]?.v || "",
            price: c[4]?.v || "",
            stock: c[5]?.v || "",
            nonStock: c[6]?.v || "",
            onShelf: c[7]?.v || "",
            acceptOrder: c[8]?.v || "",
            img: c[10]?.v || "",
          };
        });

        // 根據 selectedRole 篩選商品
        let filteredItems;
        if (selectedRole && roleMap[selectedRole]) {
          const key = roleMap[selectedRole];
          filteredItems = items.filter(item => item.role.includes(key));
        } else if (selectedRole === "仙境") {
          filteredItems = items.filter(item => item.name.includes("仙境"));
        } else if (selectedRole) {
          filteredItems = items.filter(item => item.type.includes(selectedRole) || item.name.includes(selectedRole));
        } else {
          filteredItems = items;
        }

        // 分類結果初始化
        const grouped = { "仙境": [] };
        Object.keys(roleMap).forEach(r => grouped[r] = []);
        grouped["其他角色"] = [];

        filteredItems.forEach(item => {
          if (item.name.includes("仙境")) {
            grouped["仙境"].push(item);
            return;
          }
          for (const [roleName, key] of Object.entries(roleMap)) {
            if (item.role.includes(key)) {
              grouped[roleName].push(item);
              return;
            }
          }
          grouped["其他角色"].push(item);
        });

        const content = document.getElementById("content");
        content.innerHTML = "";

        for (const [roleName, items] of Object.entries(grouped)) {
          if (items.length === 0) continue;

          const sectionTitle = document.createElement("div");
          sectionTitle.className = "section-title";
          sectionTitle.textContent = roleName;
          content.appendChild(sectionTitle);

          // 分類種類
          const typeGroups = {};
          for (const typeName of Object.keys(typeMap)) {
            typeGroups[typeName] = [];
          }
          typeGroups["其他"] = [];

          items.forEach(item => {
            let found = false;
            for (const [typeName, keywords] of Object.entries(typeMap)) {
              if (
                keywords.some(kw => item.type.includes(kw) || item.name.includes(kw))
              ) {
                typeGroups[typeName].push(item);
                found = true;
                break;
              }
            }
            if (!found) typeGroups["其他"].push(item);
          });

          for (const [typeName, typeItems] of Object.entries(typeGroups)) {
            if (typeItems.length === 0) continue;

            const divider = document.createElement("div");
            divider.className = "type-divider";
            divider.textContent = typeName;
            content.appendChild(divider);

            const cardContainer = document.createElement("div");
            cardContainer.className = "card-container";

            typeItems.forEach(item => {
              const card = document.createElement("div");
              card.className = "card";
              card.innerHTML = `
                <img src="${item.img || 'https://i.postimg.cc/bv5xRs04/image.png'}" alt="${item.name}">
                <div class="name">${item.name}</div>
                <div class="price">${item.price}</div>
                <div class="stock">${stockStatus({
                  "庫存": item.stock,
                  "非現": item.nonStock,
                  "上架": item.onShelf,
                  "受注": item.acceptOrder
                })}</div>
              `;
              cardContainer.appendChild(card);
            });

            content.appendChild(cardContainer);
          }
        }
      })
      .catch(e => {
        document.getElementById("content").innerHTML = "資料載入失敗，請稍後再試。";
        console.error(e);
      });
  </script>
</body>
</html>
