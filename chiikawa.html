<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JIWU吉物寶寶目錄</title>

<link rel="icon" href="https://i.postimg.cc/3R7nNT0k/icon.png" type="image/png" />
<link rel="apple-touch-icon" href="https://i.postimg.cc/2ytNWwWL/image.png" />
<meta name="theme-color" content="#dac7b7" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />

<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #f9f9f9;
    background-image: url('https://i.postimg.cc/Kj8V5YMg/2.png');
    background-repeat: repeat;
    background-size: 135px;
    margin: 0;
    padding: 0;
    color: #333333;
    text-align: center;
  }
  .top-bar {
    background: var(--tab-color);
    color: #fff;
    padding: 12px 0;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 999;
    user-select: none;
    font-size: 20px;
    font-weight: bold;
    animation: bounce 1.5s infinite;
  }
  .top-bar a {
    color: #fff;
    text-decoration: none;
  }
  @keyframes bounce {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
  }
  #card-container {
    padding: 80px 10px 10px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    max-width: 1200px;
    margin: 0 auto;
  }
  .type-divider {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 12px 0;
    color: #333333;
    font-weight: bold;
    user-select: none;
  }
  .type-divider::before,
  .type-divider::after {
    content: "";
    flex: 1;
    border-top: 1px solid #333333;
    margin: 0 12px;
  }
  .type-divider span {
    margin: 0 15px;
  }
  .card {
    width: 160px;
    border: 2px solid #ccc;
    border-radius: 8px;
    background-color: #fff;
    position: relative;
    cursor: pointer;
    text-align: center;
    color: #333;
    margin: 8px auto;
    transition: transform 0.2s, border-color 0.3s;
    text-decoration: none;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .card:hover {
    transform: scale(1.05);
  }
  .card img {
    width: 140px;
    height: 140px;
    object-fit: contain;
    margin-top: 8px;
    user-select: none;
  }
  .card .status {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 15px;
    font-size: 12px;
    margin: 6px 0 4px 0;
    user-select: none;
  }
  .card .name {
    font-weight: bold;
    font-size: 14px;
    margin: 2px 0 4px 0;
    user-select: none;
  }
  .card .price {
    font-size: 13px;
    margin-bottom: 10px;
    color: #555;
    user-select: none;
  }
  .role-tag {
    position: absolute;
    top: 6px;
    right: 6px;
    background-color: var(--tab-color);
    color: #fff;
    border-radius: 50%;
    width: 26px;
    height: 26px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: bold;
    user-select: none;
  }
  @media (min-width: 768px) {
    #card-container {
      flex-direction: row;
      flex-wrap: wrap;
      justify-content: flex-start;
      gap: 18px;
    }
    .card {
      margin: 0;
    }
  }
</style>
</head>
<body>

  <div class="top-bar">
    <a href="https://lin.ee/X6FUFI9" target="_blank" rel="noopener noreferrer">訂購這邊找花花 (৹˙꒳ ˙ฅ)</a>
  </div>

  <div id="card-container"></div>

  <script>
    const SHEET_ID = "1iCEqgnGGa_TVVbx90xNWxDzwKtz94VfqF8IsXRvpKMY";
    const SHEET_NAME = "ちいかわ";
    // 角色對應字與顏色
    const ROLE_MAP = {
      "吉伊": "吉",
      "小八": "八",
      "兔兔": "兔",
      "小桃": "桃",
      "師傅": "獺",
      "栗子": "栗",
      "獅薩": "獅",
      "古本": "古",
      "其他角色": "其"
    };
    const COLORS = {
      "吉伊": "#d77485",
      "小八": "#6293b8",
      "兔兔": "#f9be3c",
      "小桃": "#838BC2",
      "師傅": "#CCAFA5",
      "栗子": "#94C973",
      "獅薩": "#FBAA60",
      "古本": "#eb9e97",
      "其他角色": "#45818e"
    };

    // 從網址參數取得角色，預設吉伊
    function getCurrentRole() {
  const urlParams = new URLSearchParams(window.location.search);
  const role = urlParams.get("role");
  if (role && ROLE_MAP[role]) return role;
  return "吉伊";
}

const CURRENT_ROLE = getCurrentRole();
document.documentElement.style.setProperty('--tab-color', COLORS[CURRENT_ROLE]);
    
    // 判斷貨況狀態
    function getStatus(item) {
      if (item.preorder && item.preorder.toLowerCase() === "v")
        return { text: "受注品", bg: "#74BDCB", color: "#ffffff" };
      if (item.stock && Number(item.stock) > 0)
        return { text: "現貨", bg: "#FFF4BD", color: "#333333" };
      if ((item.stock === "0" || item.stock === 0) && (!item.notStock || item.notStock === "")) 
        return { text: "需預訂", bg: "#D4BBDD", color: "#333333" };
      if ((item.stock === "0" || item.stock === 0) && item.notStock && item.notStock !== "")
        return { text: "搭飛機中", bg: "#5885AF", color: "#ffffff" };
      return { text: "點貨中", bg: "#E7F2F8", color: "#333333" };
    }

    // 售價欄文字判斷
    function getPriceText(price) {
      if (price === "-") return "組合出售";
      if (!price || price.trim() === "") return "私訊花花";
      return price;
    }

    // 依商品名判定角色標籤（多字為綜）
    function getRoleTag(name) {
      const chars = Object.values(ROLE_MAP).filter(ch => name.includes(ch));
      if (chars.length === 1) return chars[0];
      if (chars.length > 1) return "綜";
      // 其他角色（不包含主要角色字）顯示「其」
      if (!Object.values(ROLE_MAP).some(ch => name.includes(ch))) return "其";
      return "";
    }

    // 分類種類，只顯示你指定的分類順序，有的分類可能不存在
    const TYPE_ORDER = [
      "吊娃、娃", "包包", "鑰匙圈、御守", "立牌、徽章、磁鐵、玩具",
      "文具、貼紙", "3C、居家、毛巾", "飾品、衣服", "餐廚"
    ];

    // 依種類排序分類資料
    function sortTypes(types) {
      return TYPE_ORDER.filter(t => types.includes(t))
        .concat(types.filter(t => !TYPE_ORDER.includes(t)));
    }

    // 依種類分組
    function groupByType(data) {
      const groups = {};
      data.forEach(item => {
        const t = item.type || "無類型";
        if (!groups[t]) groups[t] = [];
        groups[t].push(item);
      });
      return groups;
    }

    // 渲染卡片
    function renderCards(data) {
      const container = document.getElementById("card-container");
      container.innerHTML = "";

      // 分組
      const groups = groupByType(data);
      const sortedTypes = sortTypes(Object.keys(groups));

      sortedTypes.forEach(type => {
        const groupItems = groups[type];

        // 分類標題
        const divider = document.createElement("div");
        divider.className = "type-divider";
        divider.innerHTML = `<span>${type}</span>`;
        container.appendChild(divider);

        // 分類卡片容器(使用flex自動換行)
        const groupDiv = document.createElement("div");
        groupDiv.style.display = "flex";
        groupDiv.style.flexWrap = "wrap";
        groupDiv.style.justifyContent = "flex-start";
        groupDiv.style.gap = "12px";
        groupDiv.style.marginLeft = "6px";

        groupItems.forEach(item => {
          if (item.listing === "x") return; // 上架欄有x跳過

          const status = getStatus(item);
          const priceText = getPriceText(item.price);
          const roleTag = getRoleTag(item.name);

          const card = document.createElement("a");
          card.className = "card";
          card.href = "https://lin.ee/X6FUFI9";
          card.target = "_blank";
          card.rel = "noopener noreferrer";

          card.style.setProperty("--tab-color", COLORS[CURRENT_ROLE]);

          card.innerHTML = `
            <div class="role-tag">${roleTag}</div>
            <img src="${item.imgUrl || 'https://i.postimg.cc/bv5xRs04/image.png'}" alt="${item.name}">
            <div class="status" style="background:${status.bg};color:${status.color};width:auto;min-width:50px">${status.text}</div>
            <div class="name">${item.name}</div>
            <div class="price">${priceText}</div>
          `;

          groupDiv.appendChild(card);
        });

        container.appendChild(groupDiv);
      });
    }

    // 讀取試算表資料並過濾、格式化
    function loadData() {
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;
      fetch(url)
        .then(res => res.text())
        .then(text => {
          const json = JSON.parse(text.substr(47).slice(0, -2));
          const rows = json.table.rows;

          // 解析欄位：
          // A: 角色字串 (row.c[0])
          // B: 種類 (row.c[1])
          // C: 名稱 (row.c[2])
          // E: 售價 (row.c[4])
          // F: 庫存 (row.c[5])
          // G: 非現 (row.c[6])
          // I: 受注 (row.c[8])
          // K: 圖片URL (row.c[10])
          // L: 上架 (row.c[11])
          
          // 過濾只留下A欄含該角色字的資料，其他角色角色字「其」
          const filtered = rows
            .slice(1) // 去除標題列
            .map(row => ({
              roleStr: row.c[0]?.v || "",
              type: row.c[1]?.v || "無類型",
              name: row.c[2]?.v || "",
              price: row.c[4]?.v || "",
              stock: row.c[5]?.v || "",
              notStock: row.c[6]?.v || "",
              preorder: row.c[8]?.v || "",
              imgUrl: row.c[10]?.v || "",
              listing: row.c[11]?.v || ""
            }))
            .filter(item => {
              if (CURRENT_ROLE === "其他角色") {
                // 其他角色 = A欄角色字串不包含其他任何主要角色字
                return !Object.values(ROLE_MAP).some(ch => item.roleStr.includes(ch));
              } else {
                return item.roleStr.includes(ROLE_MAP[CURRENT_ROLE]);
              }
            });

          renderCards(filtered);
        })
        .catch(err => {
          const container = document.getElementById("card-container");
          container.innerHTML = "資料載入失敗，請稍後再試。";
          console.error(err);
        });
    }

    loadData();
  </script>

</body>
</html>
