<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>JIWU寶寶目錄</title>
<style>
  :root {
    --role-color: #dac7b7;
  }

  body {
    font-family: Arial, sans-serif;
    background-color: #f9f9f9;
    background-image: url('https://i.postimg.cc/Kj8V5YMg/2.png');
    background-repeat: repeat;
    background-size: 135px;
    margin: 0;
    padding: 0;
    color: #333;
    text-align: center;
  }

  .top-bar {
    background: var(--role-color);
    color: #fff;
    padding: 10px 0;
    position: sticky;
    top: 0;
    width: 100%;
    z-index: 999;
    font-weight: bold;
    user-select: none;
  }

  .top-bar a {
    color: #fff;
    text-decoration: underline;
    font-weight: bold;
    font-size: 16px;
    margin-left: 12px;
  }

  #product-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 12px;
    padding: 0 10px 20px;
    box-sizing: border-box;
    justify-items: center;
  }

  /* 商品分類標題在商品卡上方 */
  .type-divider {
    grid-column: 1 / -1;
    text-align: center;
    color: #333;
    font-weight: bold;
    font-size: 14px;
    user-select: none;
    margin: 20px 0 4px;
    position: relative;
  }

  .type-divider::before,
  .type-divider::after {
    content: "";
    border-top: 1px solid #333;
    position: absolute;
    top: 50%;
    width: 40%;
  }

  .type-divider::before {
    left: 0;
  }

  .type-divider::after {
    right: 0;
  }

  /* 商品卡 a 或 div */
  .product {
    width: 100%;
    border: 2px solid #ccc;
    border-radius: 8px;
    background-color: #fff;
    padding: 6px 4px 8px;
    box-sizing: border-box;
    user-select: none;
    cursor: pointer;
    text-decoration: none !important;
    color: #333 !important;
  }

  /* 移除 hover 邊框加粗 */
  /* .product:hover {
    box-shadow: 0 0 0 2px var(--role-color);
  } */

  .product img {
    width: 100%;
    height: auto;
    object-fit: contain;
    margin-bottom: 4px;
  }

  .status {
    display: inline-block;
    font-size: 10px;
    padding: 2px 12px; /* 左右各加 12px */
    border-radius: 999px; /* 橢圓 */
    margin-bottom: 4px;
    user-select: none;
    white-space: nowrap;
  }

  .status.instock {
    background-color: #FFF4BD;
    color: #333333;
  }

  .status.preorder {
    background-color: #D4BBDD;
    color: #333333;
  }

  .status.flight {
    background-color: #5885AF;
    color: #ffffff;
  }

  .status.checking {
    background-color: #E7F2F8;
    color: #ffffff;
  }

  .status.made {
    background-color: #74BDCB;
    color: #ffffff;
  }

  .name, .price {
    font-size: 12px;
    height: 24px;
    display: flex;
    justify-content: center;
    align-items: flex-end;
    line-height: 1.2;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    color: #333;
  }

  .name {
    font-weight: bold;
  }

  .bottom-bar {
    background-color: var(--role-color);
    color: #fff;
    text-align: center;
    padding: 10px 0;
    font-weight: bold;
    font-size: 14px;
    margin-top: 30px;
    user-select: none;
  }

  .bottom-bar a {
    color: #fff;
    text-decoration: underline;
  }

  .center-divider {
    width: 90vw;
    max-width: 1200px;
    border-top: 1px solid #333;
    margin: 10px auto 0;
    user-select: none;
  }

  @media (max-width: 767px) {
    #product-list {
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      padding: 12px 10px 20px;
    }

    .product {
      max-width: 82px;
      padding: 4px 2px 6px;
    }

    .product img {
      width: 80px;
    }

    .name, .price {
      font-size: 10px;
    }
  }

  @media (prefers-color-scheme: dark) {
    body {
      background-color: #222;
      color: #eee;
    }

    .product {
      background-color: #fff;
      color: #333;
    }

    .name, .price {
      color: #333;
    }
  }
</style>
</head>
<body>
<header class="top-bar" id="header-text">
    <a href="https://lin.ee/X6FUFI9" target="_blank" rel="noopener">訂購這邊找花花 (৹˙꒳˙ฅ) </a>
</header>

<main id="product-list">載入中...</main>

<script>
  // 原始 JavaScript 程式碼不變，只修改 .type-divider 插入位置
  const roleConfig = {...}; // 同上
  const categoryOrder = [...]; // 同上
  const spreadsheetId = "1iCEqgnGGa_TVVbx90xNWxDzwKtz94VfqF8IsXRvpKMY";
  const sheetURLs = {...}; // 同上

  const roleParam = new URLSearchParams(location.search).get("role") || "吉伊";
  const config = roleConfig[roleParam] || { field: null, keywords: [], color: "#ccc" };
  const sheetURL = sheetURLs[roleParam] || sheetURLs["吉伊"];

  document.documentElement.style.setProperty('--role-color', config.color);
  const container = document.getElementById("product-list");
  container.innerHTML = "載入中...";

  fetch(sheetURL)
    .then(res => {
      if (!res.ok) throw new Error("HTTP error " + res.status);
      return res.json();
    })
    .then(data => {
      const isChiiKawa = sheetURL.includes("/ちいかわ");

      const filtered = data.filter(row => {
        if (row["上架"] === "x") return false;
        if (!config.field) return true;
        return config.keywords.some(k => (row[config.field] || "").includes(k));
      });

      if (filtered.length === 0) {
        container.innerHTML = "找不到符合條件的商品";
        return;
      }

      const categorizedProducts = {};
      categoryOrder.forEach(cat => categorizedProducts[cat.label] = []);

      filtered.forEach(p => {
        let matched = false;
        for (let cat of categoryOrder) {
          if (cat.keywords.some(k => (p["種類"] || "").includes(k))) {
            categorizedProducts[cat.label].push(p);
            matched = true;
            break;
          }
        }
      });

      container.innerHTML = "";

      categoryOrder.forEach(cat => {
        const items = categorizedProducts[cat.label];
        if (items.length === 0) return;

        // 分類標題
        const divider = document.createElement("div");
        divider.className = "type-divider";
        divider.textContent = cat.label;
        container.appendChild(divider);

        // 商品卡
        items.forEach(p => {
          let status = "", statusClass = "";
          if (isChiiKawa) {
            if ((p["受注"] || "").toLowerCase().includes("v")) {
              status = "受注品"; statusClass = "made";
            } else if (parseInt(p["庫存"]) > 0) {
              status = "現貨"; statusClass = "instock";
            } else if (p["庫存"] === "0" && !p["非現"]) {
              status = "需預訂"; statusClass = "preorder";
            } else if (p["庫存"] === "0" && p["非現"]) {
              status = "搭飛機中"; statusClass = "flight";
            } else {
              status = "點貨中"; statusClass = "checking";
            }
          }

          let price = "";
          let linkUrl = "https://lin.ee/X6FUFI9";
          if (p["售價"] === "-") {
            price = "組合出售";
            linkUrl += `?text=組合出售%20${encodeURIComponent(p["名稱"])}`;
          } else if (!p["售價"]) {
            price = "私訊花花";
            linkUrl += `?text=私訊花花%20${encodeURIComponent(p["名稱"])}`;
          } else {
            price = p["售價"];
            linkUrl = null;
          }

          let imageUrl = p["圖片"]?.trim() || "https://i.postimg.cc/XJSn6Jx1/image.png";
          const product = document.createElement(linkUrl ? "a" : "div");
          product.className = "product";
          if (linkUrl) {
            product.href = linkUrl;
            product.target = "_blank";
            product.rel = "noopener";
            product.style.borderColor = config.color;
          } else {
            product.style.borderColor = config.color;
          }

          product.innerHTML = `
            <img src="${imageUrl}" alt="">
            ${status ? `<div class="status ${statusClass}">${status}</div>` : ""}
            <div class="name" title="${p["名稱"]}">${p["名稱"]}</div>
            <div class="price">${price}</div>
          `;
          container.appendChild(product);
        });
      });
    })
    .catch(err => {
      container.innerHTML = "載入資料失敗";
      console.error(err);
    });
</script>
</body>
</html>
